<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RA Geolocalizada - Demo</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }

    #info-panel {
      position: fixed;
      top: 10px;
      left: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 15px;
      border-radius: 10px;
      z-index: 999;
      font-size: 14px;
      max-height: 200px;
      overflow-y: auto;
    }

    #loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      z-index: 1000;
    }
  </style>
</head>

<body>

<div id="loading">
  <h2>Iniciando RA Geolocalizada</h2>
  <p>Solicitando permisos de c谩mara y ubicaci贸n...</p>
</div>

<div id="info-panel">
  <h3> Informaci贸n de Ubicaci贸n</h3>
  <p><strong>Tu posici贸n:</strong> <span id="user-coords">Detectando...</span></p>
  <p><strong>Precisi贸n GPS:</strong> <span id="accuracy">--</span> m</p>
  <p><strong>Puntos cercanos:</strong> <span id="nearby">0</span></p>
</div>

<a-scene
  embedded
  vr-mode-ui="enabled: false"
  arjs="sourceType: webcam; debugUIEnabled: false;"
  renderer="logarithmicDepthBuffer: true">

  <!-- C谩mara AR estable -->
  <a-camera gps-camera rotation-reader></a-camera>

  <!-- Norte -->
  <a-entity class="poi">
    <a-box color="#4CAF50" scale="2 2 2"
      animation="property: rotation; to: 0 360 0; loop: true; dur: 4000">
    </a-box>
    <a-text value="Punto Norte" position="0 3 0" scale="3 3 3"
      look-at="[gps-camera]"></a-text>
  </a-entity>

  <!-- Sur -->
  <a-entity class="poi">
    <a-sphere color="#2196F3" radius="1.5"
      animation="property: position; to: 0 2 0; dir: alternate; loop: true; dur: 2000">
    </a-sphere>
    <a-text value="Punto Sur" position="0 3 0" scale="3 3 3"
      look-at="[gps-camera]"></a-text>
  </a-entity>

  <!-- Este -->
  <a-entity class="poi">
    <a-cylinder color="#FF5722" height="3" radius="1"
      animation="property: scale; to: 1.2 1.2 1.2; dir: alternate; loop: true; dur: 1500">
    </a-cylinder>
    <a-text value="Punto Este" position="0 4 0" scale="3 3 3"
      look-at="[gps-camera]"></a-text>
  </a-entity>

  <!-- Oeste -->
  <a-entity class="poi">
    <a-cone color="#9C27B0" height="3" radius-bottom="1.5"
      animation="property: rotation; to: 360 360 0; loop: true; dur: 5000">
    </a-cone>
    <a-text value="Punto Oeste" position="0 4 0" scale="3 3 3"
      look-at="[gps-camera]"></a-text>
  </a-entity>

  <!-- Centro -->
  <a-entity class="poi">
    <a-torus color="#FFC107" radius="1" radius-tubular="0.2"
      animation="property: rotation; to: 0 360 0; loop: true; dur: 3000">
    </a-torus>
    <a-text value="Tu Ubicaci贸n" position="0 2 0" scale="2 2 2"
      look-at="[gps-camera]"></a-text>
  </a-entity>

</a-scene>

<script>
let watchId;

function calculateDestination(lat, lon, distance, bearing) {
  const R = 6371000;
  const d = distance / R;
  const brng = bearing * Math.PI / 180;

  const lat1 = lat * Math.PI / 180;
  const lon1 = lon * Math.PI / 180;

  const lat2 = Math.asin(
    Math.sin(lat1) * Math.cos(d) +
    Math.cos(lat1) * Math.sin(d) * Math.cos(brng)
  );

  const lon2 = lon1 + Math.atan2(
    Math.sin(brng) * Math.sin(d) * Math.cos(lat1),
    Math.cos(d) - Math.sin(lat1) * Math.sin(lat2)
  );

  return { lat: lat2 * 180 / Math.PI, lon: lon2 * 180 / Math.PI };
}

function updatePOIs(lat, lon) {
  const distance = 3; //  distancia corta visible

  const positions = [
    calculateDestination(lat, lon, distance, 0),
    calculateDestination(lat, lon, distance, 180),
    calculateDestination(lat, lon, distance, 90),
    calculateDestination(lat, lon, distance, 270),
    { lat, lon }
  ];

  const pois = document.querySelectorAll('.poi');
  pois.forEach((poi, i) => {
    poi.setAttribute('gps-entity-place',
      `latitude: ${positions[i].lat}; longitude: ${positions[i].lon}`);
  });

  document.getElementById('nearby').textContent = pois.length;
}

function onLocation(position) {
  const { latitude, longitude, accuracy } = position.coords;

  document.getElementById('user-coords').textContent =
    `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
  document.getElementById('accuracy').textContent = accuracy.toFixed(1);

  updatePOIs(latitude, longitude);
  document.getElementById('loading').style.display = 'none';
}

window.onload = () => {
  watchId = navigator.geolocation.watchPosition(onLocation, console.error, {
    enableHighAccuracy: true
  });
};

AFRAME.registerComponent('look-at', {
  schema: { type: 'selector' },
  tick: function () {
    if (this.data) {
      this.el.object3D.lookAt(this.data.object3D.position);
    }
  }
});
</script>

</body>
</html>
